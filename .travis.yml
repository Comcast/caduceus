sudo: required

services:
    - docker

branches:
    only:
    - master

before_install:
    - docker pull schmidtw/webpa.builder.centos6:latest
    - docker run -it -e BUILD_NUMBER=$TRAVIS_BUILD_NUMBER -d --name build schmidtw/webpa.builder.centos6 bash
    - docker exec build bash -c "mkdir codecovio_build && mkdir normal"
    - env
    - docker exec build git clone https://github.com/Comcast/caduceus.git
    - docker exec build bash -c "pushd caduceus && git fetch origin pull/ID/head:BRANCHNAME checkout -qf $TRAVIS_COMMIT && popd"
    - docker exec build git clone https://github.com/Comcast/caduceus.git codecovio_build
    - docker exec build bash -c 'pushd codecovio_build && git checkout -qf $TRAVIS_COMMIT && popd'

script:
    - docker exec build bash -c "export GOPATH=/codecovio_build && pushd codecovio_build/src && glide install && cd caduceus && go build caduceus && go test && popd"
    - 'if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then docker exec build bash -c "pushd caduceus; ./build_rpm.sh; popd"; fi'

after_success:
    - docker exec build bash <(curl -s https://codecov.io/bash) -s codecovio_build || echo "Codecov did not collect coverage reports"
    - docker cp build:/root/rpmbuild/RPMS/x86_64 .
    - docker cp build:/versionno.txt .
    - BINARY_NAME=`ls x86_64/`
    - TRAVIS_TAG=`cat versionno.txt`

deploy:
  provider: releases
  prerelease: true
  api_key: $AUTH_TOKEN_BUILD
  file: x86_64/$BINARY_NAME
  skip_cleanup: true
  on:
    condition: "$TRAVIS_PULL_REQUEST = false"

